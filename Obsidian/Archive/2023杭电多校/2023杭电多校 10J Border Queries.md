---
link: "[23HDU10J](http://acm.hdu.edu.cn/showproblem.php?pid=7392)"
done: true
tags:
  - border
  - suffix-automaton
---

为了避免下标语义冲突，我们分别用 $a$, $b$, $c$ 代替题目中的 $s_1$, $s_2$, $s_3$。根据题意，我们有以下条件：
1. $s=a+b+c$
2. $a+b=x+a$
3. $b+c=c+y$

分别结合条件 1, 2 和条件 1, 3 后我们有 $x+a+c=a+b+c=a+c+y$，即如果存在合法的划分，则 $a+c$ 一定是 $s$ 的一个 border。我们还可以发现这个条件是充分的，即如果 $a+c$ 是 $s$ 的一个 border，则将 $s$ 划分为 $a$, $b$, $c$ 后一定满足条件。

我们用 $s'$ 表示 $s$ 去掉首尾字符后的字符串。基于以上观察考虑 $b$ 需要满足哪些条件，我们有：
1. $a$, $c$ 非空，所以 $b$ 是 $s'$ 的子串。
2. $a+c$ 是 $s$ 的一个 border，所以 $|s|-|b|$ 一定等于 $s$ 的某个 border 的长度。

同样，我们也可以发现上面两个条件是充分的。如果 $b$ 是 $s'$ 的子串且 $|s|-|b|$ 等于 $s$ 的某个 border 的长度，则可直接构造 $a$, $c$ 为该 border 的一个非空划分。

因此，对于每个询问 $t_l\dots t_r$，原问题相当于求出其满足以下条件的子串 $t'$：
1. $|s'|-|t'|\in L$，其中 $L$ 是 $s$ 所有 border 长度的集合。
2. $t'$ 在 $s'$ 中出现过。

对于第一个条件，我们可以用 KMP 在 $O(n)$ 的时间里求出 $L$。对于第二个条件，我们可以先对 $s'$ 建 SAM，然后对 $t$ 的每一个前缀 $t_1\dots t_p$ 求出其为 $s'$ 字串的最长后缀 $t_{{\rm left}(p)},\dots,t_p$。这样在每次询问 $t_l\dots t_r$ 中，所有在 $s'$ 中出现的子串满足以下两个条件：
1. $l\le p\le q\le r$
2. $p\ge {\rm left}(q)$

要同时处理两个不等式有些复杂。因为 ${\rm left}(p)$ 递增，所以对于每个 $l$，我们一定可以找到一个位置 ${\rm right}(l)$，使得对所有 $q\le {\rm right}(l)$ 都有 ${\rm left}(q)\le l$，对所有 $q>{\rm right}(l)$ 都有 ${\rm left}(q)>l$。同样，${\rm right}(p)$ 也是递增的，所以可以在 $O(m)$ 的时间中预处理所有的 ${\rm right}(p)$。

这样，对于每一个询问 $t_l\dots t_r$，我们可以将子串分为 $q\le \text{right}(l)$ 和 $q>\text{right}(l)$ 两类，第一类子串可能的长度为 $[1,q-l+1]$，第二类子串可能的长度为 $[1,q-\text{left}(q)+1]$。这两种情况与 $L$ 的交都可以在 $O(n+m)$ 的时间中预处理，并对每一个询问 $O(1)$ 求和。

求解该问题的整体复杂度为 $O(|\sum|n+m+q)$，其中 $\sum$ 是字符集。