---
link: "[23HDU10A](http://acm.hdu.edu.cn/showproblem.php?pid=7383)"
done: true
tags:
  - connectivity
  - bitmask
  - matrix-tree-theorem
---

我们可以把几乎无环图分为以下三类：
1. 环的数量为 $0$，这种情况下答案是一棵树。
2. 环的数量为 $1$，这种情况下答案是一棵基环树。
3. 环的数量 $\ge 2$，这种情况下所有环都有至少一个共同点。

题目中的权值 $w$ 相当于两点之间有 $w$ 条边且不能选择重边。则情况 1 即为生成树数量，可以用矩阵树定理在 $O(n^3)$ 的时间内求出。对于情况 2，将环缩点后就是生成树数量，所以我们可以枚举环上的点集 $V'$，$V'$ 对答案的贡献即为 $V'$ 可形成环的数量乘上将 $V'$ 缩点后生成树的数量。环的数量可以用状压 DP 求出。我们枚举环上编号最小的点连出的一条边，并用状压 DP 解决剩下的链的计数，状态为链上的点集和末端点编号，复杂度为 $O(2^n\cdot n^2)$。生成树数量可以用矩阵树定理求出，复杂度分别为 $O(2^n\cdot n^3)$。

我们对情况 3 进行展开。很容易想到枚举共同点 $u$，这样删去 $u$ 后剩下的部分就是一个森林，其中每棵树上都有至少一个结点与 $u$ 相连。又因为图中存在 $\ge 2$ 个环，我们有：
1. 当环在不同的树上时，存在 $\ge 2$ 棵树中有 $\ge 2$ 条边与 $u$ 相连。
2. 当环在同一棵树上时，仅存在 $1$ 棵树中有 $\ge 3$ 条边与 $u$ 相连。

但是这样 DP 的常数太高，所以我们对这种情况进行容斥。直接求删去共同点 $u$ 后剩下的森林数，则每棵树会被枚举 $n$ 次，每棵环长为 $m$ 的基环树会被枚举 $m$ 次，减去这些情况后剩下的就是环的数量 $\ge 2$ 的情况数。

然而，当 $\ge 2$ 个环有两个以上共同点时，上面的方法也会导致重复计数。因此，我们需要讨论在什么情况下，环存在两个以上共同点。

首先看情况 1，当环在不同的树上时，因为不同环的交点只有 $u$，所以公共点唯一。而对于情况 2，我们令另一个公共点为 $v$。如果一个连通块与某个公共点有超过两条边相连，则另一个公共点会在这个环之外，所以每个连通块对每个公共点至多有一条边相连。因此，我们可以将剩下的连通块分为三类：
1. 仅有 $1$ 条边与 $u$ 相连。
2. 仅有 $1$ 条边与 $v$ 相连。
3. 有恰好 $2$ 条边分别与 $u$, $v$ 相连。这种连通块有至少 $2$ 或 $3$ 个，取决于是否选择边 $(u,v)$。
此时如果存在第三个公共点 $w$，则无论 $w$ 在哪个连通块上都在至少一个环之外。因此，公共点至多有两个。

我们同样也可以对这种情况进行容斥，求出删去 $u$, $v$ 后剩下的连通块方案，则每棵树会被枚举 $\binom{n}{2}$ 次，每棵环长为 $m$ 的基环树会被枚举 $\binom{m}{2}$ 次，减去这些情况后剩下的就是环的数量 $\ge 2$ 的情况数。注意如果不选择边 $(u,v)$ 则至少需要有一个连通块同时与 $u$, $v$ 相连才能使图连通。

因此，情况 3 的情况数即为每个结点 $u$ 作为共同点的情况数之和减去有两个共同点 $u,v$ 的情况数。在 $O(2^n\cdot n^3)$ 预处理每个子集的生成树数量之后，两种情况可以用子集枚举分别在 $O(3^n\cdot n)$ 和 $O(3^n\cdot n^2)$ 的时间内求出。