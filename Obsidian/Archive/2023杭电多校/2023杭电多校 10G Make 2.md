---
link: "[23HDU10G](http://acm.hdu.edu.cn/showproblem.php?pid=7389)"
done: true
tags:
  - deterministic-finite-automaton
  - simulation
---

首先，发现对 $i$ 操作不会改变 $a_{i-1}+a_i$ 和 $a_i+a_{i+1}$ 的值，所以对 $i$ 操作不会让任何相邻位置之和 $a_i+a_{i+1}$ 的值减小。因此，如果原本存在两个相邻位置的和大于 $4$，则这个序列绝对无法通过该操作变成全 `2` 的序列。这样，我们就把合法序列的可能性缩减到了由 `1`, `2`, `3` 组成的序列，其中 `3` 和 `2`, `3` 不能相邻。

因为改变操作顺序不会影响序列被操作过的结果，只会影响操作的合法性，即在进行某些操作时 $a_i\le 1$。为了便于计数，我们先尝试暂时忽略操作合法性，强制要求所有操作都必须从左到右依次进行，再考虑如何删除非法操作的可能性。这样，我们从左到右操作时，因为后面的操作不会改变前面的值，所以为了让上一位为 `2`，每一步的操作都可以唯一确定。我们可以由前一位和当前位如下构建 DFA 中的状态：
1. `2 2`，这也是我们需要的初始状态和结束状态，下一位对应的操作为：
	- `2 2 1`，不需要操作，转移到 `2 1`。
	- `2 2 2`，不需要操作，转移到 `2 2`。
	- `2 2 2`，此时出现 `2 3` 非法，不转移。
2. `2 1`，下一位对应的操作为：
	- `2 1 1`，不需要操作，转移到 `1 1`。
	- `2 1 2`，不需要操作，转移到 `1 2`。
	- `2 1 3`，不需要操作，转移到 `1 3`。
3. `1 2`，下一位对应的操作为：
	- `1 2 1`，操作一次变为 `2 1 2`，转移到 `1 2`。
	- `1 2 2`，操作一次变为 `2 1 3`，转移到 `1 3`。
	- `1 2 3`，此时出现 `2 3` 非法，不转移。
4. `1 3`，下一位对应的操作为：
	- `1 3 1`，操作一次变为 `2 2 2`，转移到 `2 2`。
	- `1 3 2`，此时出现 `2 3` 非法，不转移。
	- `1 3 3`，此时出现 `3 3` 非法，不转移。
5. `1 1`，下一位对应的操作为：
	- `1 1 1`，操作一次变为 `2 0 2`，转移到 `0 2`。
	- `1 1 2`，操作一次变为 `2 0 3`，转移到 `0 3`。
	- `1 1 3`，操作一次变为 `2 0 4`，此时出现 `4` 非法，不转移。
6. `0 2`，下一位对应的操作为：
	- `0 2 1`，操作两次变为 `2 0 3`，转移到 `0 3`。
	- `0 2 2`，操作两次变为 `2 0 4`，此时出现 `4` 非法，不转移。
	- `0 2 3`，此时出现 `2 3` 非法，不转移。
7. `0 3`，下一位对应的操作为：
	- `0 3 1`，操作两次变为 `2 1 3`，转移到 `1 3`。
	- `0 3 2`，此时出现 `2 3` 非法，不转移。
	- `0 3 3`，此时出现 `3 3` 非法，不转移。

接下来，我们需要讨论非法操作。非法操作即为操作时 $a_i\le 1$ 的操作，通过上面的讨论可以知道只有在 `1 1` 的情况下才会出现非法操作。要让非法操作变得合法。我们只能提前进行两边的操作。因为左方的操作已经在该操作之前，所以只能提前进行右边的操作。我们不可能对一个状态操作两次以上，所以我们可以对上述状态各扩展一维代表需要提前进行的右方操作次数。

但是，我们也可以直接对眼前的非法状态进行讨论。`1 1` 的合法后置状态只有 `0 2` 和 `0 3`，其中转移到 `0 3` 时序列末尾新增的数字是 `2`，可以直接对 `2` 进行操作，所以到 `0 3`这一步时就会直接合法。而如果转移到 `0 2`，我们观察其转移边，其在 DFA 中只可能在再加入三个 `1` 后转移到 `2 2`，其中每一步因为都需要对 `1` 进行操作而需要将右方操作提前。而转移到 `2 2` 后我们不会对该位置进行任何操作，所以没有右方操作可提前，因此，转移到 `0 2` 之后该序列不可能合法，我们可以直接将 `0 2` 从 DFA 中删去来保证操作合法性。

因此，我们得到了有 $6$ 个状态的 DFA，初始状态和结束状态都为 `2 2`，任何可以被该 DFA 接受的序列都合法。要对合法序列计数，我们只需要在 DFA 上 DP。我们可以用矩阵快速幂加速 DP 过程，时间复杂度为 $O(k^3m\log n)$，其中 $k$ 为 DFA 状态数。